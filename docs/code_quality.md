# Качественные характеристики кода

## 1. Полнота обработки ошибочных данных

- Валидация входных данных форм (`ui_request_save`, `ui_user_save`):
  - проверяются обязательные поля (дата, тип оборудования, модель, описание, заказчик);
  - проверяется формат дат (`parse_date`, формат ГГГГ-ММ-ДД);
  - проверяется совпадение паролей при создании/изменении пользователя;
  - проверяется уникальность логина пользователя.

- При ошибках валидации:
  - формируется словарь `field_errors`;
  - подсвечиваются поля формы (класс `has-error`);
  - выводится общее сообщение «Ошибка ввода данных» с рекомендацией
    «Исправьте ошибки в форме и повторите попытку».

- На уровне БД:
  - ограничения CHECK на даты (`completion_date`, `due_date >= start_date`);
  - ограничения FOREIGN KEY для ссылок на справочники;
  - триггеры для контроля соответствия ролей (`client_id` → «Заказчик», `master_id` → «Специалист»).

## 2. Наличие тестов для проверки допустимых значений

- Модульные тесты:

  - `tests/test_statistics.py`:
    - проверяет корректный расчёт:
      - общего числа заявок;
      - числа завершенных заявок;
      - среднего времени ремонта в днях;
    - учитываются как завершенные, так и незавершенные заявки.

  - `tests/test_rbac.py`:
    - проверяет, что:
      - Менеджер видит любую заявку;
      - Заказчик видит только свои заявки;
      - Специалист не может «раскрывать» финальную заявку обратно в нефинальный статус;
      - Менеджер может выполнять любые переходы статусов.

- Тесты легко расширяются за счёт того, что `RequestRow` и RBAC‑функции не привязаны к БД и UI.

## 3. Средства контроля корректности входных данных

- Вспомогательные функции:

  - `parse_int` — безопасное преобразование строки в `int` с возвратом `None` при ошибке;
  - `parse_date` — валидация формата даты с записью ошибок в `field_errors`;
  - `build_status_messages` — преобразование кодов статусов (`?status=...`)
    в понятные пользователю сообщения.

- Использование ORM‑моделей SQLAlchemy:
  - защита от SQL‑инъекций за счёт параметризованных запросов;
  - централизованное описание схемы данных.

## 4. Средства восстановления при сбоях оборудования

- Резервное копирование:

  - `scripts/backup_db.sh` и `scripts/backup_db.ps1`:
    - выполняют `pg_dump` в формат `-F c` (custom) в каталог `backups/`;
    - учитывают переменные окружения БД;
    - формируют файлы с временной меткой.

- Восстановление:
  - документация предусматривает использование `pg_restore` для загрузки дампа в новую БД.

- В случае полной потери данных учебная среда допускает
  полное пересоздание БД (с нуля) с помощью `init.sql` и `import_data.py`.

## 5. Наличие комментариев

- В коде используются только содержательные комментарии:

  - описывают:
    - назначение функций (например, `save_request`, `add_comment`, `calculate_statistics`);
    - ролевые ограничения и правила доступа (RBAC);
    - особенности обработки (например, защита от некорректных дат при расчёте статистики).

- Нет комментариев, дублирующих очевидный код («увеличиваем на 1», «сохраняем в БД»).

## 6. Проверка корректности передаваемых данных

- На уровне бизнес‑логики (`usecases.py`):

  - операции над заявками и комментариями выполняются только после проверки:

    - `user_can_create_request`;
    - `user_can_edit_request`;
    - `user_can_delete_request`;
    - `user_can_add_comment`;
    - `user_can_assign_master`;
    - `user_can_change_status`.

  - при нарушениях прав доступы выбрасываются специализированные исключения:

    - `PermissionDeniedError`;
    - `StatusChangeForbiddenError`;
    - `RequestNotFoundError`;
    - `BusinessRuleViolationError`.

  - контролируется корректность переходов статусов (например,
    запрет перевода финального статуса в нефинальный для специалиста).

- На уровне UI:

  - поля, недоступные по роли, либо скрываются, либо отключаются (`disabled`),
    чтобы пользователь не мог даже попытаться ввести запрещённые значения.

## 7. Наличие описаний основных функций

- Документация к модулям:

  - `report1.md`:
    - спецификация модуля;
    - описание алгоритмов работы с заявками;
    - описание алгоритма расчёта среднего времени ремонта.

  - `report2.md`:
    - ERD‑модель и нормализация до 3НФ;
    - описание ограничений целостности;
    - примеры отчётных запросов.

  - `Руководство системному программисту 01.md`:
    - инструкция по развёртыванию;
    - описание структуры проекта;
    - особенности обновления и резервного копирования;
    - описание новой роли «Менеджер по качеству» и QR‑функционала.

- Комментарии в коде и docstring’и позволяют быстро понять назначение функций
  и их место в архитектуре.

## 8. Мои выводы

Код модуля:

- устойчив к некорректным входным данным (валидация на уровне UI, бизнес‑логики и БД);
- покрыт модульными тестами по ключевым функциям (статистика, RBAC);
- имеет чётко выделенный слой бизнес‑логики (`usecases.py`) и слой проверок доступа (`rbac.py`);
- снабжён средствами резервного копирования и восстановления;
- сопровождается документацией по архитектуре и эксплуатации.

Это соответствует требованиям задания к качеству кода на уровне учебного проекта
и даёт основу для дальнейшего промышленного развития (добавление API, миграций, CI/CD и т.п.).