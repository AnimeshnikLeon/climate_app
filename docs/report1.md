# Задание 1 (Неделя 2). Спецификация, алгоритмы, интерфейс, тест

## 1) Краткая спецификация разрабатываемого модуля

### 1.1. Наименование
Программный модуль учета заявок на ремонт климатического оборудования.

### 1.2. Назначение
Автоматизация обработки заявок на ремонт:
- регистрация новых заявок;
- редактирование заявки (описание, статус, назначенный специалист, комплектующие);
- отслеживание статуса и поиск;
- фиксация комментариев специалиста;
- расчет статистики по работе сервисного отдела;
- управление пользователями и их ролями (для Менеджера).

### 1.3. Пользователи и роли (ограничение доступа)

Роли реализуются через справочник `user_role` и проверяются на уровне приложения (модуль `rbac.py`):

- **Менеджер**:
  - просмотр всех заявок;
  - создание/редактирование/удаление заявок;
  - назначение/смена исполнителя;
  - произвольная смена статусов заявок;
  - просмотр пользователей;
  - создание/редактирование/удаление пользователей, смена ролей и паролей;
  - доступ к статистике.

- **Оператор**:
  - просмотр всех заявок;
  - создание/редактирование/удаление заявок;
  - назначение/смена исполнителя;
  - произвольная смена статусов заявок;
  - нет доступа к управлению пользователями и статистике.

- **Специалист**:
  - просмотр только своих заявок (`master_id = текущий пользователь`);
  - редактирование только своих заявок;
  - добавление комментариев к своим заявкам;
  - смена статуса своей заявки c ограничением:
    - запрещено переводить финальную заявку обратно в нефинальный статус.

- **Заказчик**:
  - просмотр только своих заявок (`client_id = текущий пользователь`);
  - создание новых заявок;
  - редактирование своей заявки только до наступления финального статуса;
  - не может:
    - сам менять статус заявки;
    - назначать исполнителя;
    - редактировать комплектующие.

### 1.4. Входные данные (структура)

Источники данных (в рамках реализации — CSV‑импорт в БД):

- `Users`:
  - userID, fio, phone, login, password, type(роль)
- `Requests`:
  - requestID, startDate, climateTechType, climateTechModel, problemDescription,
    requestStatus, completionDate, repairParts, masterID, clientID
- `Comments`:
  - commentID, message, masterID, requestID

Данные форм (UI):

- логин, пароль;
- поля заявки: дата, тип оборудования, модель, описание проблемы, статус, дата завершения,
  комплектующие (для сотрудников сервиса), исполнитель, заказчик;
- комментарий специалиста;
- данные пользователя (для Менеджера): ФИО, телефон, логин, роль, пароль.

### 1.5. Выходные данные

- список заявок (таблица) с ключевыми полями и доступными действиями;
- карточка заявки (детали + комментарии);
- формы создания/редактирования заявок и пользователей;
- сообщения пользователю (ошибка/предупреждение/информация);
- статистический отчет:
  - количество выполненных заявок,
  - среднее время ремонта,
  - статистика по типам оборудования,
  - статистика по типам неисправностей,
  - нагрузка специалистов по активным заявкам.

---

## 2) Основной алгоритм учета заявок (текстовое описание по ГОСТ 24.301)

### 2.1. Алгоритм A1: «Работа пользователя с заявками»

**Вход**: логин/пароль; действия пользователя (создание/поиск/редактирование/просмотр/удаление).  
**Выход**: отображение списка/карточки; сохранение изменений; информативные сообщения.

1. Начало.
2. Показать форму входа.
3. Пользователь вводит логин и пароль.
4. Проверить учетные данные:
   - если неверны → вывести сообщение «Ошибка входа», перейти к п.2;
   - иначе → зафиксировать сеанс и роль пользователя, перейти к п.5.
5. Показать список заявок, доступных пользователю по роли:
   - Менеджер/Оператор: все заявки;
   - Специалист: только заявки, где `master_id = текущий пользователь`;
   - Заказчик: только заявки, где `client_id = текущий пользователь`.
6. Пользователь выбирает действие:
   - 6.1. Поиск/фильтр → применить критерии (ID/текст/статус/тип оборудования/тип неисправности), обновить список.
   - 6.2. Открыть заявку → показать карточку заявки и комментарии.
   - 6.3. Создать заявку:
       - разрешено ролям Менеджер/Оператор/Заказчик;
       - при выборе — открыть форму создания, перейти к п.7.
   - 6.4. Редактировать заявку:
       - доступно:
         - Менеджеру/Оператору — для любых заявок;
         - Специалисту — только для своих заявок;
         - Заказчику — только для своей заявки и пока её статус не финальный;
       - при выборе — открыть форму редактирования, перейти к п.7.
   - 6.5. Удалить заявку:
       - доступно только для Менеджера и Оператора;
       - при выборе — запросить подтверждение;
       - при подтверждении — удалить запись и обновить список;
       - при ошибке удаления — вывести сообщение.
   - 6.6. Выйти из системы → завершить сеанс, перейти к п.2.
7. В форме заявки пользователь вводит/изменяет данные:
   - Заказчик:
     - может указывать только описание и данные оборудования;
     - статус и исполнитель выбираются сотрудниками сервиса;
   - Оператор/Менеджер:
     - могут задавать/изменять статус, назначать исполнителя, редактировать комплектующие;
   - Специалист:
     - может редактировать описание, статус своей заявки (кроме «раскрытия» финального статуса),
       комплектующие и комментарии.
8. Выполнить валидацию:
   - обязательные поля заполнены (дата, тип оборудования, модель, описание проблемы, заказчик);
   - дата в формате ГГГГ-ММ-ДД и не пуста;
   - для сотрудников сервиса выбран статус;
   - соблюдение ролевых ограничений:
     - Заказчик не может менять статус/исполнителя/комплектующие;
     - Специалист не может перевести финальную заявку в не финальный статус;
     - исполнитель может быть выбран только из пользователей с ролью «Специалист».
   Если есть ошибки → показать сообщения на форме (с выделением полей), вернуться к п.7.
9. Сохранение заявки:
   - если заявка новая:
     - для Заказчика статус автоматически устанавливается в «Новая заявка»
       (или другой первый не финальный статус);
   - если выбран финальный статус и дата завершения пуста:
     - автоматически проставить дату текущего дня;
   - выполнить запись в хранилище (БД) через модуль бизнес‑логики `usecases.save_request`;
   - при ошибке БД → показать сообщение «Ошибка сохранения», предложить повторить позже;
   - при успехе → показать сообщение об успешном сохранении.
10. Вернуться к списку заявок (п.5).
11. Конец.

---

## 3) Детализация одной функции (F1: расчет среднего времени ремонта)

(без изменений по сравнению с предыдущей версией, но реализовано в `services.calculate_statistics_from_rows` — см. код.)

---

## 4) Реализация интерфейса по алгоритму

Реализованы следующие формы:

- `login.html` — форма входа.
- `requests.html` — список заявок + фильтры по статусу, типу оборудования и типу неисправности.
- `request_form.html` — форма создания/редактирования заявки:
  - элементы и доступность полей зависят от роли:
    - Заказчик не может выбирать статус, исполнителя и комплектующие;
    - Специалист не может переназначать заявку на другого исполнителя.
- `request_view.html` — карточка заявки + комментарии специалиста.
- `statistics.html` — статистика отдела обслуживания (только Менеджер).
- `users.html` — список пользователей (только Менеджер).
- `user_form.html` — создание/редактирование пользователя (только Менеджер).

Навигация:

- левое меню с основными разделами;
- кнопки «Назад» на формах;
- подтверждение удаления (заявок и пользователей);
- информативные сообщения (success/info/warning/error) через единый механизм `?status=...`
  и функцию `build_status_messages`.

---

## 5) Тестирование (инструментальное тестирование)

Используется `pytest` (модульные тесты).

Основные тесты:

1. `tests/test_statistics.py`:
   - проверяет:
     - общее количество заявок (`total_requests`);
     - количество завершенных заявок (`completed_requests`);
     - среднее время ремонта (`average_repair_time_days`).

2. `tests/test_rbac.py`:
   - проверяет ролевую логику:
     - Менеджер видит любую заявку;
     - Заказчик видит только свои заявки;
     - Специалист не может переводить финальную заявку обратно в не финальный статус;
     - Менеджер может выполнять произвольные переходы между статусами.

Сценарии и фиксация фактических результатов приведены в `docs/test_protocol.md`.