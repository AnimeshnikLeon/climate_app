# Задание 1 (Неделя 2). Спецификация, алгоритмы, интерфейс, тест

## 1) Краткая спецификация разрабатываемого модуля

### 1.1. Наименование
Программный модуль учета заявок на ремонт климатического оборудования.

### 1.2. Назначение
Автоматизация обработки заявок на ремонт:
- регистрация новых заявок;
- редактирование заявки (статус, описание, назначенный специалист, комплектующие);
- отслеживание статуса и поиск;
- фиксация комментариев специалиста;
- расчет статистики по работе сервисного отдела.

### 1.3. Пользователи и роли (ограничение доступа)
- **Менеджер**: просмотр всех заявок, просмотр пользователей, просмотр статистики.
- **Оператор**: регистрация/редактирование заявок, назначение специалиста, удаление заявки.
- **Специалист**: просмотр назначенных ему заявок, редактирование по своей заявке, добавление комментариев.
- **Заказчик**: создание заявки и редактирование своей заявки до финального статуса, просмотр своих заявок.

### 1.4. Входные данные (структура)
Источники данных (в рамках реализации — CSV импорт в БД, либо динамические списки):
- `Users`:
  - userID, fio, phone, login, password, type(роль)
- `Requests`:
  - requestID, startDate, climateTechType, climateTechModel, problemDescription,
    requestStatus, completionDate, repairParts, masterID, clientID
- `Comments`:
  - commentID, message, masterID, requestID

Данные формы (UI):
- логин/пароль;
- поля заявки: дата, тип оборудования, модель, описание проблемы, статус, дата завершения,
  комплектующие, специалист, заказчик;
- комментарий специалиста.

### 1.5. Выходные данные
- список заявок (таблица) с ключевыми полями;
- карточка заявки (детали + комментарии);
- сообщения пользователю (ошибка/предупреждение/информация);
- статистический отчет:
  - количество выполненных заявок,
  - среднее время ремонта,
  - статистика по типам оборудования,
  - статистика по типам неисправностей (по тексту проблемы).

---

## 2) Основной алгоритм учета заявок (текстовое описание по ГОСТ 24.301)

Ниже приведено текстовое описание алгоритма (структурированное, с условиями и ветвлениями).

### 2.1. Алгоритм A1: «Работа пользователя с заявками»

**Вход**: логин/пароль; действия пользователя (создание/поиск/редактирование/просмотр).  
**Выход**: отображение списка/карточки; сохранение изменений; сообщения.

1. Начало.
2. Показать форму входа.
3. Пользователь вводит логин и пароль.
4. Проверить учетные данные:
   - если неверны → вывести сообщение «Ошибка входа», перейти к п.2;
   - иначе → зафиксировать сеанс и роль пользователя, перейти к п.5.
5. Показать список заявок, доступных пользователю по роли:
   - Менеджер/Оператор: все заявки;
   - Специалист: только заявки, где `master_id = текущий пользователь`;
   - Заказчик: только заявки, где `client_id = текущий пользователь`.
6. Пользователь выбирает действие:
   - 6.1. Поиск/фильтр → применить критерии (ID/текст/статус/тип оборудования), обновить список.
   - 6.2. Открыть заявку → показать карточку заявки и комментарии.
   - 6.3. Создать заявку (если роль разрешает) → открыть форму создания, перейти к п.7.
   - 6.4. Редактировать заявку (если доступно по роли) → открыть форму редактирования, перейти к п.7.
   - 6.5. Удалить заявку (если роль Оператор/Менеджер) → запросить подтверждение, при согласии удалить и обновить список.
   - 6.6. Выход → завершить сеанс, перейти к п.2.
7. В форме заявки пользователь вводит/изменяет данные.
8. Выполнить валидацию:
   - обязательные поля заполнены;
   - дата в формате ГГГГ-ММ-ДД;
   - выбран статус;
   - выбран заказчик (кроме роли «Заказчик», где он фиксирован).
   Если есть ошибки → показать сообщения на форме, вернуться к п.7.
9. Сохранить заявку:
   - если выбран финальный статус и дата завершения пуста → заполнить датой текущего дня;
   - записать в хранилище (БД/массив);
   - вывести сообщение об успехе.
10. Вернуться к списку заявок (п.5).
11. Конец.

---

## 3) Детализация одной функции (выбрана: среднее время ремонта)

### 3.1. Алгоритм F1: «Расчет среднего времени ремонта (в днях)»

**Вход**: список заявок `Requests`.  
Для каждой заявки известны: `start_date`, `completion_date`, `status.is_final`.

**Выход**: `avg_days` (float) либо `null`, если нет выполненных заявок.

1. Инициализировать:
   - `sum_days = 0`
   - `count = 0`
2. Для каждой заявки `r`:
   - если `r.status.is_final = true` и `r.completion_date != null`:
     - вычислить `days = completion_date - start_date` в днях;
     - если `days >= 0`:
       - `sum_days = sum_days + days`
       - `count = count + 1`
3. Если `count = 0`, вернуть `avg_days = null`.
4. Иначе вернуть `avg_days = sum_days / count`.

Примечание по устойчивости:
- если дата завершения раньше даты начала (ошибка данных), запись не участвует в расчете.

---

## 4) Реализация интерфейса по алгоритму

В рамках задания реализованы разные формы:
- `login.html` — вход;
- `requests.html` — список заявок + фильтры;
- `request_form.html` — форма создания/редактирования заявки;
- `request_view.html` — карточка заявки + комментарии;
- `statistics.html` — статистика (менеджер);
- `users.html` — список пользователей (менеджер).

Навигация:
- меню слева + кнопки «Назад»;
- подтверждение удаления;
- информативные сообщения (success/info/warning/error).

---

## 5) Минимальный тест (инструментальное тестирование)

Использован `pytest`: см. `tests/test_statistics.py`  
Тест проверяет корректность:
- количества выполненных заявок;
- среднего времени ремонта.

Сценарий и протокол: `docs/test_protocol.md`