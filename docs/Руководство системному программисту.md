# Руководство системному программисту

## 1. Назначение и состав программного обеспечения

Программный модуль «Учет заявок на ремонт климатического оборудования» предназначен
для автоматизации процесса регистрации, обработки и контроля заявок на ремонт,
а также для сбора статистики и оценки качества работы сервисной службы.

Технологический стек:

- Backend: Python 3.12, FastAPI, SQLAlchemy 2.x.
- База данных: PostgreSQL 16.
- Веб-интерфейс: Jinja2 + CSS.
- Инфраструктура: Docker, docker-compose.
- Дополнительные компоненты:
  - `qrcode[pil]` — генерация QR‑кодов для перехода к форме оценки качества.

Основные директории:

- `app/` — исходный код приложения:
  - `main.py` — HTTP‑интерфейс (FastAPI, UI‑эндпоинты);
  - `models.py` — ORM‑модели SQLAlchemy;
  - `services.py` — служебные функции (хеширование паролей, статистика, справочники, QR‑ссылки);
  - `rbac.py` — ролевая модель и проверки доступа;
  - `usecases.py` — бизнес‑операции (создание/редактирование/удаление заявок, комментарии);
  - `ui_utils.py` — утилиты для работы с формами и статус‑сообщениями;
  - `templates/` — HTML‑шаблоны;
  - `static/` — статические ресурсы (CSS, логотип, иконки).
- `db/` — SQL‑скрипты:
  - `init.sql` — создание схемы БД, таблиц, индексов, триггеров;
  - `reports.sql` — VIEW и отчётные запросы;
  - `security.sql` — пример разграничения доступа на уровне PostgreSQL.
- `scripts/` — инфраструктурные скрипты:
  - `Dockerfile.app`, `Dockerfile.importer`;
  - `requirements.txt` — зависимости;
  - `import_data.py` — импорт CSV‑данных;
  - `backup_db.sh` / `backup_db.ps1` — резервное копирование.
- `docs/` — документация (задания 1–3, ERD, протоколы тестов).

## 2. Условия эксплуатации

### 2.1. Программные требования

- ОС: семейство Windows (по ТЗ), возможно использование Linux/macOS на серверной стороне.
- Docker и docker-compose для развёртывания.
- PostgreSQL 16 (используется официальный образ `postgres:16`).

### 2.2. Аппаратные требования (минимальные)

Для учебного стенда:

- CPU: 2 vCPU;
- RAM: 2–4 ГБ;
- Диск: 5–10 ГБ (с учётом объёма резервных копий).

## 3. Развёртывание и обновление

### 3.1. Первый запуск

1. Скопировать шаблон переменных окружения:

   ```bash
   cp .env.example .env
   ```
2. При необходимости отредактировать `.env`:

   - `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD` — параметры БД;
   - `POSTGRES_HOST`, `POSTGRES_PORT` — хост/порт PostgreSQL;
   - `APP_SECRET_KEY` — секретный ключ сессий (в проде обязателен, случайный, достаточно длинный);
   - `QUALITY_SURVEY_URL` (опционально) — URL формы оценки качества
     (по умолчанию задан в `services.QUALITY_SURVEY_BASE_URL`).
3. Запуск:

   ```bash
   docker compose up --build
   ```

   При первом старте:

   - контейнер `db` создаёт базу данных и выполняет `db/init.sql`;
   - контейнер `app` поднимает веб‑приложение на порту 8000;
   - контейнер `importer` выполняет `scripts/import_data.py` и заполняет справочники/данные.

Интерфейс доступен по адресу: `http://localhost:8000/ui/login`.

### 3.2. Обновление версии приложения

Порядок:

1. Обновить исходный код (git pull).
2. Пересобрать контейнер приложения:

   ```bash
   docker compose build app
   docker compose up -d app
   ```
3. При изменении структуры БД:

   - в учебной среде проще всего остановить стенд, удалить volume `db_data` и запустить заново
     (данные будут пересозданы из CSV);
   - в боевой среде потребуются миграции (Alembic) — в рамках учебного задания не используются.

### 3.3. Настройка параметров эксплуатации

Основные параметры задаются через `.env`:

- `POSTGRES_*` — подключение к БД.
- `APP_SECRET_KEY` — секретный ключ для `SessionMiddleware`.
- `QUALITY_SURVEY_URL` — ссылка на Google‑форму или иную систему опроса.

Изменение `QUALITY_SURVEY_URL` не требует пересборки контейнера: достаточно перезапустить `app`.

## 4. Структура БД и ролевая модель

Основные таблицы:

- `user_role` — роли пользователей:
  - «Менеджер»;
  - «Оператор»;
  - «Специалист»;
  - «Заказчик»;
  - «Менеджер по качеству».
- `app_user` — пользователи, связанные с ролями.
- `request_status` — статусы заявок (`is_final` — признак финального статуса).
- `equipment_type`, `equipment_model` — справочники оборудования.
- `issue_type` — типы неисправностей.
- `repair_request` — заявки:
  - `start_date`, `completion_date`, `due_date` (плановый срок);
  - `equipment_model_id`, `issue_type_id`, `status_id`;
  - `master_id` (исполнитель), `client_id` (заказчик);
  - `repair_parts` — текст по комплектующим;
  - служебные поля `created_at`, `updated_at`.
- `request_comment` — комментарии специалистов.

Бизнес‑правила на уровне БД:

- ограничения ссылочной целостности (`FOREIGN KEY`);
- проверка дат:
  - `completion_date >= start_date` (если дата завершения указана);
  - `due_date >= start_date` (если плановая дата указана);
- триггеры:
  - контроль соответствия ролей (`client_id` → «Заказчик», `master_id` → «Специалист»);
  - автоустановка `completion_date` для финальных статусов при сохранении без даты;
  - контроль роли специалиста в комментариях.

Ролевая модель на уровне приложения (`app/rbac.py`):

- функции `user_can_*` регулируют доступ к операциям;
- `app/usecases.py` реализует операции над заявками и комментариями с проверками RBAC.

Дополнительная роль «Менеджер по качеству»:

- видит все заявки;
- может изменять заявки (в том числе назначать исполнителей, менять статусы);
- может изменять плановый срок выполнения (`due_date`);
- не управляет пользователями и не видит статистику (эти права есть только у Менеджера).

## 5. Генерация QR‑кодов для оценки качества

Для генерации QR‑кодов используется пакет `qrcode[pil]`.

Маршрут:

- `GET /ui/requests/{request_id}/qr`

Алгоритм:

1. Проверить наличие аутентифицированного пользователя.
2. Проверить, что заявка с указанным `request_id` существует.
3. Сформировать URL опроса через `services.build_quality_survey_url(request_id)`.
4. Сгенерировать QR‑код в памяти (`qrcode.make(...)`) и вернуть как PNG (`StreamingResponse`).

QR‑код отображается в шаблоне `request_view.html`:

```html
<img src="/ui/requests/{{ req.id }}/qr"
     alt="QR-код для оценки качества работы"
     style="width: 200px; height: 200px;">
```

При необходимости изменить целевой опрос достаточно изменить переменную
окружения `QUALITY_SURVEY_URL`.

## 6. Резервное копирование и восстановление

Скрипты:

- `scripts/backup_db.sh` — для Linux/macOS;
- `scripts/backup_db.ps1` — для Windows PowerShell.

Оба скрипта:

- определяют имя контейнера БД (`climate_db`);
- читают `POSTGRES_DB` и `POSTGRES_USER` из окружения или используют значения по умолчанию;
- создают файл резервной копии в каталоге `backups/` в формате `pg_dump -F c`.

Пример запуска:

```bash
./scripts/backup_db.sh
# или
./scripts/backup_db.ps1
```

Восстановление (пример):

```bash
createdb climate_service_restore
pg_restore -d climate_service_restore -F c backups/climate_service_YYYYMMDD_HHMMSS.dump
```

## 7. Диагностика и восстановление после сбоев

### 7.1. Логи

- Логи контейнера `db` (PostgreSQL):
  - ошибки подключения, проблемы с диском, сбои запросов.
- Логи контейнера `app`:
  - stack trace’ы Python, ошибки валидации, исключения SQLAlchemy.

Просмотр логов:

```bash
docker compose logs app
docker compose logs db
```

### 7.2. Типичные проблемы

1. **Не запускается приложение (`app`)**:

   - проверить, что `db` в состоянии `healthy` (`docker ps`);
   - проверить параметры подключения к БД в `.env`;
   - проверить логи контейнера `app`.
2. **Ошибки при сохранении заявок**:

   - см. сообщения «Ошибка сохранения» в UI;
   - проверить логи `app` и `db`;
   - возможные причины:
     - нарушение CHECK‑ограничений (например, `due_date < start_date`);
     - нарушение триггеров (`client_id` не ссылается на «Заказчика», `master_id` — не на «Специалиста»).
3. **Проблемы с генерацией QR‑кода**:

   - убедиться, что установлен пакет `qrcode[pil]` (устанавливается из `scripts/requirements.txt`);
   - проверить, что `QUALITY_SURVEY_URL` имеет корректный формат URL.

### 7.3. Восстановление после аппаратных сбоев

- При утере данных БД:
  - развернуть PostgreSQL;
  - восстановить из последнего резервного дампа (`pg_restore`);
  - перезапустить контейнер `app`.

---

## 8. Изменение конфигурации ролей и добавление пользователей

Роли хранятся в таблице `user_role`. Скрипт импорта (`import_data.py`) гарантирует наличие
ролей, в том числе «Менеджер по качеству».

Пользователи создаются:

- либо через CSV‑импорт (`data/import/inputDataUsers.csv`);
- либо через веб-интерфейс (страницы `/ui/users`, `/ui/users/new`, `/ui/users/{id}/edit`)
  под учетной записью Менеджера.

Рекомендуется:

- не править роли вручную через SQL;
- использовать UI для создания пользователей и назначения им ролей.
